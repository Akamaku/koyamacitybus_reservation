<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>狐山市交通局 車両予約サイト</title>
<meta name="description" content="狐山市交通局一部車両予約サイト">
<link rel="stylesheet" href="styles.css">
<style>
  body { font-family: "Hiragino Kaku Gothic ProN", sans-serif; padding: 2em; }
  form { max-width: 420px; display: grid; gap: 1em; margin-bottom: 2em; }
  label { display: grid; gap: .3em; }
  select, input, button { padding: .6em; font-size: 1em; }
  #result, #checkResult { margin-top: 1em; white-space: pre-wrap; border: 1px solid #ccc; padding: 1em; }
  header { margin-bottom: 2em; }
  nav a { margin-right: 1em; text-decoration: none; }
</style>
</head>

<body>
<header class="site-header">
  <a class="brand" href="index.html">狐山市交通局一部車両予約サイト</a>
  <nav class="site-nav">
    <a href="shinmachi.html">新町営業所</a>
    <a href="kitano.html">喜多野営業所</a>
    <a href="katakami.html">片上営業所</a>
  </nav>
</header>

<h1>片上営業所 一部車両予約</h1>

<form id="reserveForm">
  <label>車両：
    <select name="car" required>
      <option value="">選択してください</option>
      <option value="K-R0902号車">K-R0902号車</option>
    </select>
  </label>

  <label>日付：
    <input type="date" name="date" id="date" required>
  </label>

  <label>開始時刻：
    <select id="start" name="start" required></select>
  </label>

  <label>終了時刻：
    <select id="end" name="end" required></select>
  </label>

  <label>お名前：
    <input name="name" required>
  </label>

  <button type="submit">予約する</button>
</form>

<div id="result"></div>

<hr>

<h2>予約確認</h2>
<form id="checkForm">
  <label>予約パスワード：
    <input id="checkPass" required>
  </label>
  <button type="submit">確認する</button>
</form>

<div id="checkResult"></div>

<script>
const apiURL = "https://script.google.com/macros/s/AKfycbw4bRgAV1M2qk9rJXp_tIC0KPfZvC_4RLbk0ehmVIVBpr7oOH-rR4SFcCDy3thHODtb5w/exec"; 
const office = "片上営業所";

const dateInput = document.getElementById('date');
const startSel = document.getElementById('start');
const endSel = document.getElementById('end');
const result = document.getElementById('result');
const checkResult = document.getElementById('checkResult');

// --- 今日以降しか選べない ---
const today = new Date();
const yyyy = today.getFullYear();
const mm = String(today.getMonth() + 1).padStart(2, '0');
const dd = String(today.getDate()).padStart(2, '0');
dateInput.min = `${yyyy}-${mm}-${dd}`;

// --- 時刻リスト生成（0,15,30,45分刻み） ---
function generateTimes() {
  for (let h = 0; h < 24; h++) {
    for (let m of [0,15,30,45]) {
      const t = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
      startSel.add(new Option(t, t));
      endSel.add(new Option(t, t));
    }
  }
}
generateTimes();

// --- 予約送信 ---
document.getElementById('reserveForm').addEventListener('submit', (e) => {
  e.preventDefault();
  const fd = new FormData(e.target);
  const car = fd.get('car');
  const date = fd.get('date');
  const start = fd.get('start');
  const end = fd.get('end');
  const name = fd.get('name');

  if (end <= start) {
    alert("終了時刻は開始時刻より後を選んでください。");
    return;
  }

  const now = new Date();
  const startDateTime = new Date(`${date}T${start}`);
  if (startDateTime < now) {
    alert("過去の日時は予約できません。");
    return;
  }

  const pass = Math.random().toString(36).slice(-6).toUpperCase();

  fetch(apiURL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ office, car, date, start, end, name, pass })
  })
  .then(r => r.json())
  .then(res => {
    if (res.ok) {
      result.textContent = 
`予約が完了しました！
----------------------------
営業所：${office}
車両：${car}
日付：${date}
開始：${start}
終了：${end}
お名前：${name}
予約番号：${res.id}
パスワード：${pass}
----------------------------
このパスワードで予約確認ができます。`;
      e.target.reset();
    } else {
      alert("送信エラーが発生しました。");
    }
  })
  .catch(() => alert("通信エラーが発生しました。"));
});

// --- 予約確認 ---
document.getElementById('checkForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const pass = document.getElementById('checkPass').value.trim().toUpperCase();
  if (!pass) return;

  const res = await fetch(`${apiURL}?pass=${encodeURIComponent(pass)}`);
  const data = await res.json();

  if (data.ok) {
    checkResult.textContent = 
`予約が見つかりました。
----------------------------
営業所：${office}
車両：${data.car}
日付：${data.date}
開始：${data.start}
終了：${data.end}
お名前：${data.name}
予約番号：${data.id}`;
  } else {
    checkResult.textContent = "該当する予約が見つかりません。";
  }
});
</script>
</body>
</html>